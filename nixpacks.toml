[phases.setup]
nixPkgs = ["go", "nodejs_18", "npm-9_x"]

[phases.install]
cmds = [
  "echo 'ðŸ“¦ Install phase starting...'",
  "echo 'Installing migrate CLI...'",
  "go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest",
  "echo 'Migrate CLI installed. Checking location:'",
  "ls -la $(go env GOPATH)/bin/migrate || echo 'migrate binary not found'",
  "echo 'PATH=/root/go/bin:$PATH' >> /root/.profile",
  "echo 'PATH=/root/go/bin:$PATH' >> /root/.bashrc",
  "export PATH=/root/go/bin:$PATH",
  "echo 'PATH updated. Current PATH:' $PATH",
  "npm ci"
]

[phases.build]
cmds = [
  "echo 'ðŸ”§ Build phase starting...'",
  "export PATH=/root/go/bin:$PATH",
  "echo 'Current PATH:' $PATH",
  "echo 'Go binary path:' $(go env GOPATH)/bin",
  "echo 'Checking if migrate is available:'",
  "which migrate || echo 'migrate not found in PATH'",
  "npm run build"
]

[start]
cmd = "export PATH=/root/go/bin:$PATH && npm run start:with-migrations"
